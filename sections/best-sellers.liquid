{{ 'best-sellers.css' | asset_url | stylesheet_tag }}

{% assign has_collections = false %}
{% for block in section.blocks %}
  {% if block.settings.collection != blank %}
    {% assign has_collections = true %}
    {% break %}
  {% endif %}
{% endfor %}

{% if has_collections %}
  <div class="best-sellers__container container">
    <div class="best-sellers__collections">
      {% if section.settings.section_label != blank %}
        <p class="best-sellers__pretitle">{{ section.settings.section_label }}</p>
      {% endif %}

      {% if section.settings.title != blank %}
        <h2 class="best-sellers__title">{{ section.settings.title }}</h2>
      {% endif %}

      <ul class="best-sellers__collections-list">
        {% for block in section.blocks %}
          {% assign collection = block.settings.collection %}
          {% assign custom_title = block.settings.collection_title %}
          {% assign custom_product = block.settings.product %}

          {% if collection != blank %}
            <li {{ block.shopify_attributes }}>
              <button
                class="best-sellers__item{% if forloop.first %} active{% endif %}"
                data-collection-button
                data-collection-index="{{ forloop.index0 }}"
                data-block-id="{{ block.id }}"
              >
                <h3 class="best-sellers__item-title">
                  {% if custom_title != blank %}
                    {{ custom_title }}
                  {% else %}
                    {{ collection.title }}
                  {% endif %}
                </h3>

                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M14.4297 5.93005L20.4997 12.0001L14.4297 18.0701" stroke="black" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M3.5 12H20.33" stroke="black" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
            </li>
          {% endif %}
        {% endfor %}
      </ul>
    </div>

    <div class="best-sellers__preview-wrapper">
      {% for block in section.blocks %}
        {% assign collection = block.settings.collection %}
        {% assign custom_product = block.settings.product %}

        {% if collection != blank %}
          {% if custom_product != blank %}
            {% assign product = custom_product %}
          {% else %}
            {% assign product = collection.products.first %}
          {% endif %}

          {% if product != blank %}
          <div
            class="best-sellers__preview{% if forloop.first %} active{% endif %}"
            data-preview
            data-collection-index="{{ forloop.index0 }}"
            data-variant-id="{{ product.selected_or_first_available_variant.id }}"
            data-product-title="{{ product.title | escape }}"
            data-product-available="{{ product.selected_or_first_available_variant.available }}"
          >
            {% if product.featured_image %}
              <a class="best-sellers__preview-img-wrapper" href="{{ product.url }}">
                {{
                  product.featured_image
                  | image_url: width: 1600
                  | image_tag:
                    widths: '375, 550, 750, 1100, 1500, 1780, 2000, 3000, 3840',
                    sizes: '(min-width: 1936px) 832px, (min-width: 769px) calc((100vw - 144px) / 2), calc(100vw - 128px)',
                    class: 'best-sellers__preview-img',
                    loading: 'lazy',
                    alt: product.featured_image.alt | default: product.title
                }}
              </a>

            {% else %}
              <a class="best-sellers__preview-img-wrapper" href="{{ product.url }}">
                {{ 'product-1' | placeholder_svg_tag: 'best-sellers__preview-img best-sellers__preview-img--placeholder' }}
              </a>
            {% endif %}

            {% if product.tags.size > 0 %}
              <div class="best-sellers__badges">
                {% assign tags_count = 0 %}
                {% for tag in product.tags %}
                  {% if tags_count < 3 %}
                    {% assign tag_downcase = tag | downcase %}
                    <div class="best-sellers__badge{% if tag_downcase == 'sale' %} best-sellers__badge--sale{% else %} best-sellers__badge--new{% endif %}">
                      {{ tag }}
                    </div>
                    {% assign tags_count = tags_count | plus: 1 %}
                  {% endif %}
                {% endfor %}
              </div>
            {% endif %}

            <div class="best-sellers__btns">
              <button
                class="best-sellers__btn best-sellers__btn-wishlist"
                data-wishlist-btn
                type="button"
                aria-label="Add to wishlist"
              >
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M20.8382 4.60999C20.3274 4.099 19.721 3.69364 19.0535 3.41708C18.3861 3.14052 17.6707 2.99817 16.9482 2.99817C16.2257 2.99817 15.5103 3.14052 14.8428 3.41708C14.1754 3.69364 13.5689 4.099 13.0582 4.60999L11.9982 5.66999L10.9382 4.60999C9.90647 3.5783 8.5072 2.9987 7.04817 2.9987C5.58913 2.9987 4.18986 3.5783 3.15817 4.60999C2.12647 5.64169 1.54688 7.04096 1.54688 8.49999C1.54687 9.95903 2.12647 11.3583 3.15817 12.39L4.21817 13.45L11.9982 21.23L19.7782 13.45L20.8382 12.39C21.3492 11.8792 21.7545 11.2728 22.0311 10.6053C22.3076 9.93789 22.45 9.22248 22.45 8.49999C22.45 7.77751 22.3076 7.0621 22.0311 6.39464C21.7545 5.72718 21.3492 5.12075 20.8382 4.60999V4.60999Z" stroke="black" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
              <button
                class="best-sellers__btn best-sellers__btn-cart"
                data-cart-btn
                type="button"
                aria-label="Add to cart"
                {% unless product.selected_or_first_available_variant.available %}disabled{% endunless %}
              >
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M15.5819 12C15.5819 13.98 13.9819 15.58 12.0019 15.58C10.0219 15.58 8.42188 13.98 8.42188 12C8.42188 10.02 10.0219 8.42004 12.0019 8.42004C13.9819 8.42004 15.5819 10.02 15.5819 12Z" stroke="black" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M11.9998 20.27C15.5298 20.27 18.8198 18.19 21.1098 14.59C22.0098 13.18 22.0098 10.81 21.1098 9.39997C18.8198 5.79997 15.5298 3.71997 11.9998 3.71997C8.46984 3.71997 5.17984 5.79997 2.88984 9.39997C1.98984 10.81 1.98984 13.18 2.88984 14.59C5.17984 18.19 8.46984 20.27 11.9998 20.27Z" stroke="black" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
            </div>

            <div class="best-sellers__preview-info">
              <a class="best-sellers__preview-name" href="{{ product.url }}">{{ product.title }}</a>
              <div class="best-sellers__preview-price-wrapper">
                {% if product.compare_at_price > product.price %}
                  <p class="best-sellers__preview-price best-sellers__preview-price--current">
                    {{ product.price | money }}
                  </p>
                  <p class="best-sellers__preview-price best-sellers__preview-price--old">
                    {{ product.compare_at_price | money }}
                  </p>
                {% else %}
                  <p class="best-sellers__preview-price best-sellers__preview-price--current">
                    {{ product.price | money }}
                  </p>
                {% endif %}
              </div>
            </div>
          </div>
          {% endif %}
        {% endif %}
      {% endfor %}
    </div>
  </div>

  {%- comment -%} Wishlist Modal {%- endcomment -%}
  <div class="best-sellers__modal-overlay" data-modal-overlay>
    <div class="best-sellers__modal">
      <button class="best-sellers__modal-close" data-modal-close type="button" aria-label="Close modal">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M18 6L6 18M6 6L18 18" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
      <p class="best-sellers__modal-text" data-modal-text></p>
    </div>
  </div>

  <script>
      document.addEventListener('DOMContentLoaded', function() {
          const collectionButtons = document.querySelectorAll('[data-collection-button]');
          const previewItems = document.querySelectorAll('[data-preview]');
          const wishlistButtons = document.querySelectorAll('[data-wishlist-btn]');
          const cartButtons = document.querySelectorAll('[data-cart-btn]');
          const modal = document.querySelector('[data-modal-overlay]');
          const modalText = document.querySelector('[data-modal-text]');
          const modalClose = document.querySelector('[data-modal-close]');

          // Helper function to get scrollbar width
          function getScrollbarWidth() {
              return window.innerWidth - document.documentElement.clientWidth;
          }

          // Open modal
          function openModal(message) {
              const scrollbarWidth = getScrollbarWidth();
              modalText.textContent = message;

              if (scrollbarWidth > 0) {
                  document.body.style.paddingRight = scrollbarWidth + 'px';
              }

              document.body.style.overflow = 'hidden';
              modal.classList.add('show');
          }

          // Close modal
          function closeModal() {
              modal.classList.remove('show');
              document.body.style.overflow = '';
              document.body.style.paddingRight = '';
          }

          // Initialize inactive state on page load
          collectionButtons.forEach(button => {
              if (!button.classList.contains('active')) {
                  button.classList.add('inactive');
              }
          });

          // Switch collection
          collectionButtons.forEach(button => {
              button.addEventListener('click', function() {
                  if (this.classList.contains('active')) return;

                  const index = this.dataset.collectionIndex;

                  // Update buttons
                  collectionButtons.forEach(btn => {
                      btn.classList.remove('active');
                      btn.classList.add('inactive');
                  });
                  this.classList.add('active');
                  this.classList.remove('inactive');

                  // Update preview
                  previewItems.forEach(preview => {
                      preview.classList.remove('active');
                      if (preview.dataset.collectionIndex === index) {
                          preview.classList.add('active');
                      }
                  });
              });
          });

          // Wishlist functionality
          wishlistButtons.forEach(button => {
              button.addEventListener('click', function(e) {
                  e.preventDefault();
                  const preview = this.closest('[data-preview]');
                  const productTitle = preview.dataset.productTitle;

                  openModal(`${productTitle} has been added to your wishlist.`);
              });
          });

          // Add to cart functionality
          cartButtons.forEach(button => {
              button.addEventListener('click', function(e) {
                  e.preventDefault();
                  if (this.disabled) return;

                  const preview = this.closest('[data-preview]');
                  const variantId = preview.dataset.variantId;
                  const productTitle = preview.dataset.productTitle;

                  // Add to cart via Ajax API
                  fetch('/cart/add.js', {
                      method: 'POST',
                      headers: {
                          'Content-Type': 'application/json',
                      },
                      body: JSON.stringify({
                          id: variantId,
                          quantity: 1
                      })
                  })
                      .then(response => {
                          if (!response.ok) {
                              throw new Error('Failed to add to cart');
                          }
                          return response.json();
                      })
                      .then(data => {
                          console.log('Product added to cart:', data);
                          // Show success message in modal
                          openModal(`${productTitle} has been added to cart.`);
                      })
                      .catch(error => {
                          console.error('Error adding to cart:', error);
                          // Show error message in modal
                          openModal('Error adding product to cart. Please try again.');
                      });
              });
          });

          // Modal event listeners
          modalClose.addEventListener('click', closeModal);

          modal.addEventListener('click', function(e) {
              if (e.target === modal) {
                  closeModal();
              }
          });

          // Close modal on Escape key
          document.addEventListener('keydown', function(e) {
              if (e.key === 'Escape' && modal.classList.contains('show')) {
                  closeModal();
              }
          });
      });
  </script>
{% endif %}

{% schema %}
{
  "name": "Best Sellers",
  "tag": "section",
  "class": "best-sellers",
  "settings": [
    {
      "type": "text",
      "id": "section_label",
      "label": "Section label",
      "default": "Best sellers"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "Trending Products"
    }
  ],
  "blocks": [
    {
      "type": "collection",
      "name": "Collection",
      "limit": 3,
      "settings": [
        {
          "type": "collection",
          "id": "collection",
          "label": "Collection"
        },
        {
          "type": "text",
          "id": "collection_title",
          "label": "Collection title",
          "info": "Leave empty to use collection name"
        },
        {
          "type": "product",
          "id": "product",
          "label": "Product",
          "info": "Leave empty to use first product from collection"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Best Sellers"
    }
  ]
}
{% endschema %}