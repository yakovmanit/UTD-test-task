{{ 'best-sellers.css' | asset_url | stylesheet_tag }}

{% assign has_collections = false %}
{% for block in section.blocks %}
  {% if block.settings.collection != blank %}
    {% assign has_collections = true %}
    {% break %}
  {% endif %}
{% endfor %}

{% if has_collections %}
  <div class="best-sellers__container container">
    <div class="best-sellers__collections">
      {% if section.settings.section_label != blank %}
        <p class="best-sellers__pretitle">{{ section.settings.section_label }}</p>
      {% endif %}

      {% if section.settings.title != blank %}
        <h2 class="best-sellers__title">{{ section.settings.title }}</h2>
      {% endif %}

      <ul class="best-sellers__collections-list">
        {% for block in section.blocks %}
          {% assign collection = block.settings.collection %}
          {% assign custom_title = block.settings.collection_title %}
          {% assign custom_product = block.settings.product %}

          {% if collection != blank %}
            <li {{ block.shopify_attributes }}>
              <button
                class="best-sellers__item{% if forloop.first %} active{% endif %}"
                data-collection-button
                data-collection-index="{{ forloop.index0 }}"
                data-block-id="{{ block.id }}"
              >
                <h3 class="best-sellers__item-title">
                  {% if custom_title != blank %}
                    {{ custom_title }}
                  {% else %}
                    {{ collection.title }}
                  {% endif %}
                </h3>

                {% render "icon-arrow" %}
              </button>
            </li>
          {% endif %}
        {% endfor %}
      </ul>
    </div>

    <div class="best-sellers__preview-wrapper">
      {% for block in section.blocks %}
        {% assign collection = block.settings.collection %}
        {% assign custom_product = block.settings.product %}

        {% if collection != blank %}
          {% if custom_product != blank %}
            {% assign product = custom_product %}
          {% else %}
            {% assign product = collection.products.first %}
          {% endif %}

          {% if product != blank %}
          <div
            class="best-sellers__preview{% if forloop.first %} active{% endif %}"
            data-preview
            data-collection-index="{{ forloop.index0 }}"
            data-variant-id="{{ product.selected_or_first_available_variant.id }}"
            data-product-title="{{ product.title | escape }}"
            data-product-available="{{ product.selected_or_first_available_variant.available }}"
          >
            <div class="best-sellers__preview-img-wrapper">
              {% if product.featured_image %}
                <a href="{{ product.url }}" class="best-sellers__image-link">
                  <picture>
                    {%- comment -%} Mobile {%- endcomment -%}
                    <source
                      media="(max-width: 767px)"
                      srcset="
                        {{ product.featured_image | image_url: width: 400 }} 1x,
                        {{ product.featured_image | image_url: width: 800 }} 2x
                      "
                    >

                    {%- comment -%} Desktop {%- endcomment -%}
                    <source
                      media="(min-width: 768px)"
                      srcset="
                        {{ product.featured_image | image_url: width: 816 }} 1x,
                        {{ product.featured_image | image_url: width: 1632 }} 2x
                      "
                    >

                    {%- comment -%} For old browsers {%- endcomment -%}
                    <img
                      src="{{ product.featured_image | image_url: width: 816 }}"
                      alt="{{ product.featured_image.alt | default: product.title | escape }}"
                      class="best-sellers__preview-img"
                      width="{{ product.featured_image.width }}"
                      height="{{ product.featured_image.height }}"
                      loading="lazy"
                    >
                  </picture>
                </a>
              {% else %}
                <div class="best-sellers__image-link">
                  {{ 'product-1' | placeholder_svg_tag: 'best-sellers__preview-img best-sellers__preview-img--placeholder' }}
                </div>
              {% endif %}

              {% if product.tags.size > 0 %}
                <div class="best-sellers__badges">
                  {% assign tags_count = 0 %}
                  {% for tag in product.tags %}
                    {% if tags_count < 3 %}
                      {% assign tag_downcase = tag | downcase %}
                      <div class="best-sellers__badge{% if tag_downcase == 'sale' %} best-sellers__badge--sale{% endif %}">
                        {{ tag }}
                      </div>
                      {% assign tags_count = tags_count | plus: 1 %}
                    {% endif %}
                  {% endfor %}
                </div>
              {% endif %}

              <div class="best-sellers__btns">
                <button
                  class="best-sellers__btn best-sellers__btn-wishlist"
                  data-wishlist-btn
                  type="button"
                  aria-label="Add to wishlist"
                >
                  {% render 'icon-wishlist' %}
                </button>
                <button
                  class="best-sellers__btn best-sellers__btn-cart"
                  data-cart-btn
                  type="button"
                  aria-label="Add to cart"
                  {% unless product.selected_or_first_available_variant.available %}disabled{% endunless %}
                >
                  {% render 'icon-eye' %}
                </button>
              </div>

              <div class="best-sellers__preview-info">
                <a class="best-sellers__preview-name" href="{{ product.url }}">{{ product.title }}</a>
                <div class="best-sellers__preview-price-wrapper">
                  {% if product.compare_at_price > product.price %}
                    <p class="best-sellers__preview-price best-sellers__preview-price--current">
                      {{ product.price | money }}
                    </p>
                    <p class="best-sellers__preview-price best-sellers__preview-price--old">
                      {{ product.compare_at_price | money }}
                    </p>
                  {% else %}
                    <p class="best-sellers__preview-price best-sellers__preview-price--current">
                      {{ product.price | money }}
                    </p>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
          {% endif %}
        {% endif %}
      {% endfor %}
    </div>
  </div>

  {%- comment -%} Wishlist Modal {%- endcomment -%}
  <div class="best-sellers__modal-overlay" data-modal-overlay>
    <div class="best-sellers__modal">
      <button class="best-sellers__modal-close" data-modal-close type="button" aria-label="Close modal">
        {% render 'icon-close' %}
      </button>
      <p class="best-sellers__modal-text" data-modal-text></p>
    </div>
  </div>

  <script>
      document.addEventListener('DOMContentLoaded', function() {
          const collectionButtons = document.querySelectorAll('[data-collection-button]');
          const previewItems = document.querySelectorAll('[data-preview]');
          const wishlistButtons = document.querySelectorAll('[data-wishlist-btn]');
          const cartButtons = document.querySelectorAll('[data-cart-btn]');
          const modal = document.querySelector('[data-modal-overlay]');
          const modalText = document.querySelector('[data-modal-text]');
          const modalClose = document.querySelector('[data-modal-close]');

          // Helper function to get scrollbar width
          function getScrollbarWidth() {
              return window.innerWidth - document.documentElement.clientWidth;
          }

          // Open modal
          function openModal(message) {
              const scrollbarWidth = getScrollbarWidth();
              modalText.textContent = message;

              if (scrollbarWidth > 0) {
                  document.body.style.paddingRight = scrollbarWidth + 'px';
              }

              document.body.style.overflow = 'hidden';
              modal.classList.add('show');
          }

          // Close modal
          function closeModal() {
              modal.classList.remove('show');
              document.body.style.overflow = '';
              document.body.style.paddingRight = '';
          }

          // Initialize inactive state on page load
          collectionButtons.forEach(button => {
              if (!button.classList.contains('active')) {
                  button.classList.add('inactive');
              }
          });

          // Switch collection
          collectionButtons.forEach(button => {
              button.addEventListener('click', function() {
                  if (this.classList.contains('active')) return;

                  const index = this.dataset.collectionIndex;

                  // Update buttons
                  collectionButtons.forEach(btn => {
                      btn.classList.remove('active');
                      btn.classList.add('inactive');
                  });
                  this.classList.add('active');
                  this.classList.remove('inactive');

                  // Update preview
                  previewItems.forEach(preview => {
                      preview.classList.remove('active');
                      if (preview.dataset.collectionIndex === index) {
                          preview.classList.add('active');
                      }
                  });
              });
          });

          // Wishlist functionality
          wishlistButtons.forEach(button => {
              button.addEventListener('click', function(e) {
                  e.preventDefault();
                  const preview = this.closest('[data-preview]');
                  const productTitle = preview.dataset.productTitle;

                  openModal(`${productTitle} has been added to your wishlist.`);
              });
          });

          // Add to cart functionality
          cartButtons.forEach(button => {
              button.addEventListener('click', function(e) {
                  e.preventDefault();
                  if (this.disabled) return;

                  const preview = this.closest('[data-preview]');
                  const variantId = preview.dataset.variantId;
                  const productTitle = preview.dataset.productTitle;

                  // Add to cart via Ajax API
                  fetch('/cart/add.js', {
                      method: 'POST',
                      headers: {
                          'Content-Type': 'application/json',
                      },
                      body: JSON.stringify({
                          id: variantId,
                          quantity: 1
                      })
                  })
                      .then(response => {
                          if (!response.ok) {
                              throw new Error('Failed to add to cart');
                          }
                          return response.json();
                      })
                      .then(data => {
                          console.log('Product added to cart:', data);
                          // Show success message in modal
                          openModal(`${productTitle} has been added to cart.`);
                      })
                      .catch(error => {
                          console.error('Error adding to cart:', error);
                          // Show error message in modal
                          openModal('Error adding product to cart. Please try again.');
                      });
              });
          });

          // Modal event listeners
          modalClose.addEventListener('click', closeModal);

          modal.addEventListener('click', function(e) {
              if (e.target === modal) {
                  closeModal();
              }
          });

          // Close modal on Escape key
          document.addEventListener('keydown', function(e) {
              if (e.key === 'Escape' && modal.classList.contains('show')) {
                  closeModal();
              }
          });
      });
  </script>
{% endif %}

{% schema %}
{
  "name": "Best Sellers",
  "tag": "section",
  "class": "best-sellers",
  "settings": [
    {
      "type": "text",
      "id": "section_label",
      "label": "Section label",
      "default": "Best sellers"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "Trending Products"
    }
  ],
  "blocks": [
    {
      "type": "collection",
      "name": "Collection",
      "limit": 3,
      "settings": [
        {
          "type": "collection",
          "id": "collection",
          "label": "Collection"
        },
        {
          "type": "text",
          "id": "collection_title",
          "label": "Collection title",
          "info": "Leave empty to use collection name"
        },
        {
          "type": "product",
          "id": "product",
          "label": "Product",
          "info": "Leave empty to use first product from collection"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Best Sellers"
    }
  ]
}
{% endschema %}